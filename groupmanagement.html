<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Add Member(s) to Group</title>
  <!-- Load ethers.js from a CDN -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f7f7f7;
      color: #333;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    h1 {
      text-align: center;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      display: block;
      margin: 20px auto 0 auto;
      padding: 10px 20px;
      background: #5C49E4;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #4A39CC;
    }
    #status {
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Add Member(s) to Group</h1>
    
    <!-- Group contract address -->
    <label for="groupAddress">Group Contract Address:</label>
    <input type="text" id="groupAddress" placeholder="0x..." />
    
    <!-- Member addresses (comma separated) -->
    <label for="members">Member Address(es) (comma separated):</label>
    <input type="text" id="members" placeholder="0x..., 0x..., ..." />
    
    <!-- Expiry timestamp with default fallback -->
    <label for="expiry">Expiry (UNIX timestamp; default: 9999999999):</label>
    <input type="number" id="expiry" placeholder="9999999999" />
    
    <button id="addMembersBtn">Add Member(s)</button>
    
    <div id="status"></div>
  </div>

  <script>
    let provider, signer, groupContract;
    
    // The minimal ABI including the trustBatch function.
    const groupABI = [
      "function trustBatch(address[] memory _coreMembers, uint96 _expiry) external"
    ];
    
    // Initialize provider and signer using the injected Ethereum provider.
    async function init() {
      if (typeof window.ethereum === 'undefined') {
        document.getElementById("status").innerText =
          "No Ethereum provider detected. Please install MetaMask (or a compatible wallet).";
        return;
      }
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
    }
    
    // Function to add multiple members using trustBatch.
    async function addMembers() {
      const groupAddress = document.getElementById("groupAddress").value.trim();
      if (!ethers.utils.isAddress(groupAddress)) {
        document.getElementById("status").innerText = "Invalid group contract address.";
        return;
      }
      
      // Create a contract instance with the provided group address.
      groupContract = new ethers.Contract(groupAddress, groupABI, signer);
      
      // Process the member addresses input.
      let membersInput = document.getElementById("members").value.trim();
      if (!membersInput) {
        document.getElementById("status").innerText = "Please enter at least one member address.";
        return;
      }
      let addresses = membersInput.split(",")
                        .map(addr => addr.trim())
                        .filter(addr => ethers.utils.isAddress(addr));
      if (addresses.length === 0) {
        document.getElementById("status").innerText = "No valid member addresses found.";
        return;
      }
      
      // Get expiry value; use default if missing or invalid.
      let expiryInput = document.getElementById("expiry").value.trim();
      let expiry = (!expiryInput || isNaN(expiryInput)) ? 9999999999 : Number(expiryInput);
      
      try {
        const tx = await groupContract.trustBatch(addresses, expiry);
        document.getElementById("status").innerText = `Transaction submitted: ${tx.hash}\nWaiting for confirmation...`;
        await tx.wait();
        document.getElementById("status").innerText = `Members added successfully! Tx hash: ${tx.hash}`;
      } catch (error) {
        console.error(error);
        document.getElementById("status").innerText = "Error: " + error.message;
      }
    }
    
    window.addEventListener("DOMContentLoaded", async () => {
      await init();
      document.getElementById("addMembersBtn").addEventListener("click", addMembers);
    });
  </script>
</body>
</html>
